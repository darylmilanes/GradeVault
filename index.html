<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GradeVault Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-body: #fafeff;
            --primary-blue: #004080;
            --primary-dark: #002a55;
            --text-main: #2c3e50;
            --text-muted: #6c757d;
            --border-light: #e2e8f0;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --warning-orange: #fd7e14;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden; 
        }

        /* --- Custom Toast Notifications --- */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 1060;
            display: flex; flex-direction: column; gap: 10px;
        }
        .custom-toast {
            background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            padding: 15px 20px; min-width: 300px; display: flex; align-items: center; gap: 12px;
            animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            border-left: 5px solid var(--primary-blue);
        }
        .custom-toast.success { border-left-color: var(--success-green); }
        .custom-toast.error { border-left-color: var(--danger-red); }
        .toast-icon { font-size: 1.2rem; }
        .toast-msg { font-weight: 500; font-size: 0.95rem; }
        
        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Navbar */
        .navbar { 
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark)) !important; 
            box-shadow: 0 4px 12px rgba(0, 64, 128, 0.15); padding: 0.8rem 0;
        }
        .navbar-brand { color: white !important; font-weight: 800; font-size: 1.3rem; display: flex; align-items: center; gap: 12px; }
        .logo-box { background: rgba(255,255,255,0.2); border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .brand-text { letter-spacing: -0.5px; }
        .brand-subtitle { font-weight: 300; opacity: 0.9; font-size: 0.85em; margin-left: 4px; }
        .btn-outline-light { border-radius: 50px; font-size: 0.8rem; }
        .icon-btn { border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; padding: 0; }

        /* Cards */
        .card { border: none; border-radius: 12px; box-shadow: var(--card-shadow); background-color: white; margin-bottom: 1rem; }
        .hidden { display: none !important; }

        /* Login */
        #login-section { min-height: 80vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-container { width: 100%; max-width: 400px; padding: 35px 30px; background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 64, 128, 0.1); border-top: 6px solid var(--primary-blue); margin: 20px auto; }

        /* Inputs & Buttons */
        .form-control, .form-select { border-radius: 8px; border: 1px solid var(--border-light); padding: 10px 15px; background-color: #f8fafc; font-size: 16px; }
        .form-control:focus, .form-select:focus { background-color: white; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1); }
        .btn { border-radius: 8px; font-weight: 500; padding: 10px 20px; transition: all 0.2s; }
        
        /* Tables */
        .table-responsive { border-radius: 12px; border: 1px solid var(--border-light); overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table th { font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; padding: 12px; white-space: nowrap; }
        .table td { padding: 10px 12px; vertical-align: middle; white-space: nowrap; }
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 10; border-right: 2px solid var(--border-light) !important; color: var(--primary-blue); font-weight: 600; }

        /* Inputs & Grades */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .table-input { width: 60px; text-align: center; border: 1px solid transparent; background: transparent; border-radius: 4px; font-weight: 600; font-size: 1rem; padding: 5px 0; }
        .table-input:focus { border-color: var(--primary-blue); background-color: white; outline: none; }
        .grade-cell { font-weight: 800; font-size: 1rem; text-align: center; }
        .failing-grade { color: var(--danger-red); background-color: #fff5f5; border-radius: 4px; }
        .badge { padding: 5px 10px; border-radius: 30px; font-weight: 500; }

        /* Student Portal */
        .grade-card { display: flex; flex-direction: column; justify-content: center; height: 100%; padding: 15px; border: 1px solid var(--border-light); border-top: 4px solid var(--primary-blue); text-align: center; position: relative; }
        .grade-value { font-size: 2.2rem; font-weight: 800; color: var(--primary-blue); line-height: 1.1; margin-bottom: 5px; }
        .grade-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; }
        
        .forecast-box { background-color: #fff8f0; border: 1px dashed var(--warning-orange); padding: 5px; border-radius: 6px; margin-top: 10px; color: #856404; font-size: 0.85rem; }
        .forecast-val { font-weight: 800; color: var(--warning-orange); font-size: 1rem; }

        /* Progress Bar in Card */
        .card-progress-container { width: 100%; background-color: #e9ecef; border-radius: 4px; height: 6px; margin-top: 10px; overflow: hidden; }
        .card-progress-bar { height: 100%; background-color: var(--success-green); width: 0%; transition: width 0.5s ease; }
        .progress-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; display: block; }

        /* Nav & Action Bar */
        #student-subject-select { background-color: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; font-weight: 600; text-align: center; }
        #student-subject-select option { background-color: var(--primary-blue); color: white; }
        .nav-tabs { border-bottom: 2px solid var(--border-light); margin-bottom: 15px; flex-wrap: nowrap; overflow-x: auto; }
        .nav-link { white-space: nowrap; color: var(--text-muted); font-weight: 600; border: none; padding: 10px 20px; }
        .nav-link.active { color: var(--primary-blue); border-bottom: 3px solid var(--primary-blue); background: transparent; }
        .action-bar { border-top: 1px solid var(--border-light); background: #f8f9fa; border-radius: 0 0 12px 12px; }

        #target-grade-input::placeholder { color: #d1d5db; font-weight: 400; }

        .date-header-input { border: none; background: transparent; font-weight: 700; color: var(--primary-blue); width: 80px; text-align: center; font-size: 0.8rem; }
        .att-cell { border-left: 1px solid rgba(0,0,0,0.05); } 
        .att-select { border: none; background: transparent; font-weight: 600; cursor: pointer; text-align: center; -webkit-appearance: none; appearance: none; width: 100%; }
        .att-present { color: var(--success-green); } .att-absent { color: var(--danger-red); } .att-late { color: var(--warning-orange); } .att-excused { color: var(--primary-blue); opacity: 0.7; }

        .progress { height: 10px; border-radius: 5px; background-color: #e9ecef; overflow: hidden; margin-top: 10px; }
        .progress-bar { background-color: var(--primary-blue); transition: width 0.3s ease; }

        @media (min-width: 992px) {
            #student-subject-select { width: auto; min-width: 250px; }
            #student-name-display { margin-top: 0px; opacity: 0.9; }
        }
        @media (max-width: 991px) {
            .container-fluid { padding-left: 15px; padding-right: 15px; }
            .card .row.g-3 > div { width: 100%; margin-bottom: 10px; }
            .action-bar { flex-direction: column; gap: 10px; }
            .action-bar button { width: 100% !important; }
            #attendance-buttons { flex-direction: column; width: 100%; gap: 10px; }
            .col-sm-6 { width: 50%; }
            .target-calc-container { flex-direction: column; align-items: flex-start !important; }
            .target-calc-input { width: 100% !important; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
            .navbar-brand { font-size: 1.1rem; }
            #student-subject-select { width: 100%; margin-top: 5px; }
            #student-name-display { font-size: 0.9rem; font-weight: 500; color: rgba(255,255,255,0.9); margin-top: 5px; display: block; width: 100%; text-align: center; }
        }
    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- 1. LOGIN SECTION -->
    <div id="login-section">
        <div class="login-container">
            <h3 class="text-center mb-4" style="font-weight: 800; color: var(--primary-blue); display:flex; align-items:center; justify-content:center; gap:10px;">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:40px; height:40px; font-size:1.2rem;">
                    <i class="bi bi-mortarboard-fill"></i>
                </div>
                <div>GradeVault</div>
            </h3>
            <div class="mb-3">
                <label class="form-label">User ID / Email</label>
                <input type="text" id="login-uid" class="form-control" placeholder="ID or Email" onkeydown="if(event.key==='Enter') handleLogin()">
            </div>
            <div class="mb-4">
                <label class="form-label">Password</label>
                <input type="password" id="login-pass" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter') handleLogin()">
            </div>
            <button id="btn-login" onclick="handleLogin()" class="btn btn-primary w-100 py-2 fw-bold d-flex align-items-center justify-content-center gap-2">
                <span>Sign In</span>
                <div id="login-spinner" class="spinner-border spinner-border-sm text-white d-none" role="status"></div>
            </button>
        </div>
    </div>

    <!-- 2. TEACHER PORTAL -->
    <div id="teacher-section" class="hidden">
        <nav class="navbar navbar-expand-lg mb-3">
            <div class="container-fluid px-3 d-flex justify-content-between">
                <span class="navbar-brand">
                    <div class="logo-box"><i class="bi bi-mortarboard-fill"></i></div>
                    <span class="brand-text">GradeVault</span>
                    <span class="brand-subtitle">Teacher</span>
                </span>
                <button onclick="logout()" class="btn btn-outline-light icon-btn" title="Sign Out"><i class="bi bi-power"></i></button>
            </div>
        </nav>
        <div class="container-fluid">
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <h6 class="mb-0 text-primary fw-bold">Class Management</h6>
                            <div class="d-flex gap-2">
                                <button onclick="document.getElementById('import-modal').classList.remove('hidden')" class="btn btn-sm btn-outline-secondary fw-bold" title="Import CSV">
                                    <i class="bi bi-folder-plus"></i> <span class="d-none d-md-inline">Import</span>
                                </button>
                                <button onclick="openSettingsModal()" class="btn btn-sm btn-outline-primary fw-bold" title="Configuration">
                                    <i class="bi bi-gear"></i> <span class="d-none d-md-inline">Config</span>
                                </button>
                            </div>
                        </div>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3 col-12">
                                <label class="form-label">Term</label>
                                <select id="term-select" class="form-select">
                                    <option value="prelim">Prelim</option>
                                    <option value="midterm">Midterm</option>
                                    <option value="finals">Finals</option>
                                </select>
                            </div>
                            <div class="col-md-4 col-12">
                                <label class="form-label">Section</label>
                                <select id="section-select" class="form-select"><option value="">Loading...</option></select>
                            </div>
                            <div class="col-md-3 col-12">
                                <label class="form-label">View Mode</label>
                                <select id="view-mode" class="form-select" onchange="toggleTeacherButtons()">
                                    <option value="list">Student List</option>
                                    <option value="scores">Scores</option>
                                    <option value="attendance">Attendance</option>
                                </select>
                            </div>
                            <div class="col-md-2 col-12">
                                <button onclick="loadClassList()" class="btn btn-primary w-100 fw-bold">Load List</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="results-area" class="hidden">
                <div class="card p-0 overflow-hidden shadow-sm">
                    <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                        <h6 id="table-title" class="m-0 fw-bold text-primary">Class List</h6>
                        <span class="badge bg-light text-dark border">Live</span>
                    </div>
                    <div class="table-responsive border-0">
                        <table class="table table-hover mb-0" id="data-table">
                            <thead id="table-head"></thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                    <div id="bottom-action-bar" class="action-bar p-3 d-flex justify-content-end gap-2 hidden">
                        <div id="scores-buttons" class="hidden w-100 d-flex justify-content-end">
                            <button onclick="saveScores()" class="btn btn-success px-4 fw-bold shadow-sm">üíæ Save Scores</button>
                        </div>
                        <div id="attendance-buttons" class="hidden w-100 d-flex justify-content-between align-items-center">
                            <button onclick="addDateColumn()" class="btn btn-outline-primary fw-bold">+ Date</button>
                            <button onclick="saveAttendance()" class="btn btn-success px-4 fw-bold shadow-sm">üíæ Save Log</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. STUDENT PORTAL -->
    <div id="student-section" class="hidden">
        <nav class="navbar navbar-expand-lg mb-4">
            <div class="container px-3">
                <div class="row w-100 align-items-center gx-0">
                    <div class="col-lg-6 col-12 d-flex flex-column mb-2 mb-lg-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="navbar-brand">
                                <div class="logo-box"><i class="bi bi-mortarboard-fill"></i></div>
                                <span class="brand-text">GradeVault</span>
                                <span class="brand-subtitle">Student</span>
                            </span>
                            <button onclick="logout()" class="btn btn-outline-light icon-btn d-lg-none"><i class="bi bi-power"></i></button>
                        </div>
                        <div class="text-white small fw-medium" id="student-name-display" style="line-height:1.2;">Loading...</div>
                    </div>
                    <div class="col-lg-6 col-12 d-flex justify-content-lg-end justify-content-center align-items-center gap-3">
                        <select id="student-subject-select" class="form-select form-select-sm" onchange="switchStudentSubject()"></select>
                        <button onclick="logout()" class="btn btn-outline-light icon-btn d-none d-lg-flex"><i class="bi bi-power"></i></button>
                    </div>
                </div>
            </div>
        </nav>
        
        <div class="container px-3">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card p-3 border-0 shadow-sm" style="background: linear-gradient(to right, #ffffff, #f8faff);">
                        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-3 target-calc-container">
                            <div class="d-flex align-items-center gap-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:42px; height:42px; font-size:1.3rem;">
                                    <i class="bi bi-calculator"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold text-primary">Target Calculator</h6>
                                    <p class="mb-0 text-muted small">Set goal to see required grades.</p>
                                </div>
                            </div>
                            <div class="target-calc-input d-flex align-items-center gap-2">
                                <span class="fw-bold text-muted small">MY GOAL:</span>
                                <input type="number" id="target-grade-input" class="form-control fw-bold text-primary text-center" style="width: 80px;" placeholder="90" oninput="calculateForecast()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Grade Cards with Progress Bars -->
            <div class="row mb-4 g-3">
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card grade-card">
                        <div class="grade-label">Prelim</div>
                        <div class="grade-value" id="s-prelim">--</div>
                        <div class="badge bg-light text-muted border fw-normal" style="font-size:0.7em" id="lbl-prelim-w">--%</div>
                        <div class="forecast-box hidden" id="f-prelim-box"><div class="forecast-val" id="f-prelim">--</div></div>
                        <!-- Progress Bar Container (Hidden by default, shown via JS) -->
                        <div class="card-progress-container hidden" id="p-prelim-bar-box">
                            <div class="card-progress-bar" id="p-prelim-bar"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card grade-card">
                        <div class="grade-label">Midterm</div>
                        <div class="grade-value" id="s-midterm">--</div>
                        <div class="badge bg-light text-muted border fw-normal" style="font-size:0.7em" id="lbl-mid-w">--%</div>
                        <div class="forecast-box hidden" id="f-midterm-box"><div class="forecast-val" id="f-midterm">--</div></div>
                        <div class="card-progress-container hidden" id="p-midterm-bar-box">
                            <div class="card-progress-bar" id="p-midterm-bar"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card grade-card">
                        <div class="grade-label">Finals</div>
                        <div class="grade-value" id="s-finals">--</div>
                        <div class="badge bg-light text-muted border fw-normal" style="font-size:0.7em" id="lbl-fin-w">--%</div>
                        <div class="forecast-box hidden" id="f-finals-box"><div class="forecast-val" id="f-finals">--</div></div>
                        <div class="card-progress-container hidden" id="p-finals-bar-box">
                            <div class="card-progress-bar" id="p-finals-bar"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card grade-card" style="border-top-color: var(--success-green); background: #f0fff4;">
                        <div class="grade-label text-success">Total</div>
                        <div class="grade-value text-success" id="s-card">--</div>
                        <div class="small text-muted mt-1" style="font-size:0.7em">Final Grade</div>
                        <div class="card-progress-container hidden" id="p-card-bar-box">
                            <div class="card-progress-bar" id="p-card-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="card p-3">
                        <h6 class="mb-3 fw-bold text-primary">Breakdown</h6>
                        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                            <li class="nav-item"><button class="nav-link active" onclick="showStudentTerm('prelim', this)">Prelim</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="showStudentTerm('midterm', this)">Midterm</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="showStudentTerm('finals', this)">Finals</button></li>
                        </ul>
                        <div id="student-term-detail" class="fade-in"><p class="text-muted text-center py-4 small">Select a term...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h6 class="modal-title fw-bold">‚öôÔ∏è Configuration</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <h6 class="text-primary fw-bold text-uppercase small mb-3">Component Weights (%)</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-6"><label class="form-label small">Quizzes</label><input type="number" id="w-quiz" class="form-control"></div>
                        <div class="col-6"><label class="form-label small">Projects</label><input type="number" id="w-proj" class="form-control"></div>
                        <div class="col-6"><label class="form-label small">Exams</label><input type="number" id="w-exam" class="form-control"></div>
                        <div class="col-6"><label class="form-label small">Attendance</label><input type="number" id="w-att" class="form-control"></div>
                    </div>
                    <h6 class="text-primary fw-bold text-uppercase small mb-3">Term Weights (%)</h6>
                    <div class="row g-3">
                        <div class="col-4"><label class="form-label small">Prelim</label><input type="number" id="w-prelim" class="form-control"></div>
                        <div class="col-4"><label class="form-label small">Midterm</label><input type="number" id="w-mid" class="form-control"></div>
                        <div class="col-4"><label class="form-label small">Finals</label><input type="number" id="w-fin" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer bg-light p-2">
                    <button type="button" class="btn btn-primary w-100" onclick="saveSettings()">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <div id="import-modal" class="card p-4 hidden shadow-lg" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:400px; z-index:1050; border-top: 5px solid var(--primary-blue);">
        <h6 class="mb-3 fw-bold">Import Student Data</h6>
        <div class="mb-3">
            <input type="file" id="csv-file" accept=".csv" class="form-control">
            <div class="form-text small">Select formatted CSV.</div>
        </div>
        
        <div id="import-progress-container" class="hidden mb-3">
            <div class="d-flex justify-content-between small mb-1">
                <span>Uploading...</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="progress">
                <div id="import-progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button onclick="document.getElementById('import-modal').classList.add('hidden')" class="btn btn-light btn-sm">Cancel</button>
            <button onclick="processCSV()" class="btn btn-primary btn-sm">Upload</button>
        </div>
    </div>

    <div class="modal fade" id="attModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content border-0">
                <div class="modal-header bg-light py-2">
                    <h6 class="modal-title fw-bold text-primary">Attendance Log</h6>
                    <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" id="att-modal-body"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyALyoSZFrB9odSuydyDvRkVGCDdDQa0Ub8",
          authDomain: "gradevault-app.firebaseapp.com",
          projectId: "gradevault-app",
          storageBucket: "gradevault-app.firebasestorage.app",
          messagingSenderId: "538075460552",
          appId: "1:538075460552:web:1175068265c9ffe78d86fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.writeBatch = writeBatch;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
    </script>

    <script>
        let currentStudents = []; 
        let currentTerm = "";
        let existingDates = [];
        let allStudentSubjects = [];
        let activeStudentSubject = null;

        // ======================================================
        // PASTE YOUR ADMIN UID HERE
        // ======================================================
        const ADMIN_UID = "Xv71xkRee8grRRhpfO2WYKoQhEC2"; 
        // ======================================================

        let globalWeights = { quiz: 20, project: 30, exam: 40, attendance: 10, prelim: 25, midterm: 35, finals: 40 };

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            const icon = type === 'success' ? 'bi-check-circle-fill text-success' : 'bi-exclamation-triangle-fill text-danger';
            toast.innerHTML = `<i class="bi ${icon} toast-icon"></i><div class="toast-msg">${msg}</div>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function handleLogin() {
            const uidInput = document.getElementById('login-uid').value.trim();
            const passInput = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('btn-login');
            const spinner = document.getElementById('login-spinner');

            if (!uidInput || !passInput) { showToast("Enter credentials", "error"); return; }
            
            btn.disabled = true;
            spinner.classList.remove('d-none');

            await fetchSettings();

            try {
                if (uidInput.includes("@")) {
                    const userCredential = await window.signInWithEmailAndPassword(window.auth, uidInput, passInput);
                    if (userCredential.user.uid === ADMIN_UID) {
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('teacher-section').classList.remove('hidden');
                        await fetchSectionsForDropdown();
                        showToast("Welcome, Admin!");
                    } else { throw new Error("Access Denied"); }
                } else {
                    const q = window.query(window.collection(window.db, "students"), window.where("uid", "==", uidInput), window.where("password", "==", passInput));
                    const snapshot = await window.getDocs(q);
                    if (!snapshot.empty) {
                        allStudentSubjects = [];
                        snapshot.forEach(doc => allStudentSubjects.push(doc.data()));
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('student-section').classList.remove('hidden');
                        initStudentPortal();
                        showToast("Welcome Student!");
                    } else { throw new Error("Invalid Credentials"); }
                }
            } catch (error) { 
                showToast(error.message, "error"); 
                btn.disabled = false;
                spinner.classList.add('d-none');
            }
        }

        function logout() { window.signOut(window.auth).then(() => location.reload()).catch(() => location.reload()); }
        async function fetchSettings() {
            try {
                const docSnap = await window.getDoc(window.doc(window.db, "settings", "config"));
                if (docSnap.exists()) globalWeights = docSnap.data();
            } catch (e) { console.error("Error loading settings:", e); }
        }
        window.openSettingsModal = function() {
            document.getElementById('w-quiz').value = globalWeights.quiz;
            document.getElementById('w-proj').value = globalWeights.project;
            document.getElementById('w-exam').value = globalWeights.exam;
            document.getElementById('w-att').value = globalWeights.attendance;
            document.getElementById('w-prelim').value = globalWeights.prelim;
            document.getElementById('w-mid').value = globalWeights.midterm;
            document.getElementById('w-fin').value = globalWeights.finals;
            new bootstrap.Modal(document.getElementById('settingsModal')).show();
        }
        window.saveSettings = async function() {
            const newWeights = {
                quiz: parseFloat(document.getElementById('w-quiz').value),
                project: parseFloat(document.getElementById('w-proj').value),
                exam: parseFloat(document.getElementById('w-exam').value),
                attendance: parseFloat(document.getElementById('w-att').value),
                prelim: parseFloat(document.getElementById('w-prelim').value),
                midterm: parseFloat(document.getElementById('w-mid').value),
                finals: parseFloat(document.getElementById('w-fin').value)
            };
            const compTotal = newWeights.quiz + newWeights.project + newWeights.exam + newWeights.attendance;
            const termTotal = newWeights.prelim + newWeights.midterm + newWeights.finals;
            if (compTotal !== 100) { showToast(`Components must be 100%`, "error"); return; }
            if (termTotal !== 100) { showToast(`Term Weights must be 100%`, "error"); return; }
            try {
                await window.setDoc(window.doc(window.db, "settings", "config"), newWeights);
                globalWeights = newWeights;
                showToast("Configuration Saved");
                bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
                if(activeStudentSubject) renderStudentPage(activeStudentSubject);
            } catch (e) { showToast(e.message, "error"); }
        }
        function toggleTeacherButtons() {
            const mode = document.getElementById('view-mode').value;
            const bar = document.getElementById('bottom-action-bar');
            const scoresBtn = document.getElementById('scores-buttons');
            const attBtn = document.getElementById('attendance-buttons');
            bar.classList.add('hidden'); scoresBtn.classList.add('hidden'); attBtn.classList.add('hidden');
            if (mode === 'scores') { bar.classList.remove('hidden'); scoresBtn.classList.remove('hidden'); }
            else if (mode === 'attendance') { bar.classList.remove('hidden'); attBtn.classList.remove('hidden'); }
        }
        async function fetchSectionsForDropdown() {
            const select = document.getElementById('section-select');
            try {
                const q = window.query(window.collection(window.db, "students"));
                const querySnapshot = await window.getDocs(q);
                const sections = new Set();
                querySnapshot.forEach(doc => { if(doc.data().section) sections.add(doc.data().section); });
                select.innerHTML = '<option value="">Select Section</option>';
                Array.from(sections).sort().forEach(sec => {
                    const opt = document.createElement('option');
                    opt.value = sec; opt.textContent = sec; select.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }
        async function loadClassList() {
            const section = document.getElementById('section-select').value;
            currentTerm = document.getElementById('term-select').value;
            const mode = document.getElementById('view-mode').value;
            if (!section) { showToast("Select a section", "error"); return; }
            toggleTeacherButtons();
            const q = window.query(window.collection(window.db, "students"), window.where("section", "==", section));
            const snapshot = await window.getDocs(q);
            currentStudents = [];
            snapshot.forEach(doc => { let d = doc.data(); d.docID = doc.id; currentStudents.push(d); });
            currentStudents.sort((a, b) => a.name.localeCompare(b.name));
            if (mode === 'attendance') {
                const dateSet = new Set();
                currentStudents.forEach(s => {
                    if (s.attendance_logs && s.attendance_logs[currentTerm]) 
                        Object.keys(s.attendance_logs[currentTerm]).forEach(d => dateSet.add(d));
                });
                existingDates = Array.from(dateSet).sort();
                const minCols = 10;
                while (existingDates.length < minCols) { existingDates.push(""); }
            }
            renderTable(currentStudents, mode, currentTerm);
        }
        
        window.handleTableEnter = function(e, input) {
            if (e.key !== 'Enter') return;
            e.preventDefault();
            const td = input.closest('td');
            const tr = td.closest('tr');
            const colIndex = Array.from(tr.children).indexOf(td);
            const nextTr = tr.nextElementSibling;
            if (nextTr) {
                const nextTd = nextTr.children[colIndex];
                const nextInput = nextTd.querySelector('input');
                if (nextInput) nextInput.focus();
            }
        }

        function renderTable(students, mode, term) {
            const tbody = document.getElementById('table-body');
            const thead = document.getElementById('table-head');
            document.getElementById('results-area').classList.remove('hidden');
            document.getElementById('table-title').innerText = `Section ${students[0]?.section || ''} | ${term.toUpperCase()} (${mode})`;
            tbody.innerHTML = ''; thead.innerHTML = '';
            
            if (mode === 'list') {
                thead.innerHTML = `<tr><th>Student Name</th><th>User ID</th><th>Course</th><th>Status</th></tr>`;
                students.forEach(s => {
                    tbody.innerHTML += `<tr><td class="fw-bold text-primary">${s.name}</td><td>${s.uid}</td><td>${s.course}</td><td><span class="badge ${s.status === 'Active' ? 'bg-success' : 'bg-danger'}">${s.status}</span></td></tr>`;
                });
            } else if (mode === 'scores') {
                thead.innerHTML = `<tr><th class="sticky-col">Name</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Q5</th><th>Prj</th><th>Exm</th><th class="bg-light">Att%</th><th class="bg-light">Grd</th></tr>`;
                students.forEach(s => {
                    if (s.status === "Dropped") return;
                    const sc = (s.scores && s.scores[term]) ? s.scores[term] : {};
                    const g = (s.grades && s.grades[term]) ? s.grades[term] : "";
                    const att = (s.attendance && s.attendance[term]) ? s.attendance[term] : 0;
                    tbody.innerHTML += `
                        <tr data-id="${s.docID}">
                            <td class="sticky-col">${s.name}</td>
                            <td><input type="number" class="table-input q-input" value="${sc.q1||''}" oninput="calcRow(this)" onkeydown="handleTableEnter(event, this)"></td>
                            <td><input type="number" class="table-input q-input" value="${sc.q2||''}" oninput="calcRow(this)" onkeydown="handleTableEnter(event, this)"></td>
                            <td><input type="number" class="table-input q-input" value="${sc.q3||''}" oninput="calcRow(this)" onkeydown="handleTableEnter(event, this)"></td>
                            <td><input type="number" class="table-input q-input" value="${sc.q4||''}" oninput="calcRow(this)" onkeydown="handleTableEnter(event, this)"></td>
                            <td><input type="number" class="table-input q-input" value="${sc.q5||''}" oninput="calcRow(this)" onkeydown="handleTableEnter(event, this)"></td>
                            <td><input type="number" class="table-input p-input" value="${sc.proj||''}" oninput="calcRow(this)" onkeydown="handleTableEnter(event, this)"></td>
                            <td><input type="number" class="table-input e-input" value="${sc.exam||''}" oninput="calcRow(this)" onkeydown="handleTableEnter(event, this)"></td>
                            <td class="text-center att-score">${att}%</td>
                            <td class="grade-cell ${g<75&&g!==''?'failing-grade':''}">${g}</td>
                        </tr>`;
                });
            } else if (mode === 'attendance') {
                let h = `<tr id="att-head"><th class="sticky-col">Name</th>`;
                existingDates.forEach(d => h += `<th><input type="text" class="date-header-input" value="${d}"></th>`);
                h += `<th width="80" class="bg-light">Total</th></tr>`;
                thead.innerHTML = h;
                students.forEach(s => {
                    if (s.status === "Dropped") return;
                    const logs = (s.attendance_logs && s.attendance_logs[term]) ? s.attendance_logs[term] : {};
                    let r = `<tr data-id="${s.docID}"><td class="sticky-col">${s.name}</td>`;
                    existingDates.forEach(d => {
                        let val = "";
                        if (d !== "") { val = logs[d] || ""; }
                        r += `<td class="att-cell">${getAttDropdown(val)}</td>`;
                    });
                    r += `<td class="text-center fw-bold att-total">${(s.attendance && s.attendance[term])?s.attendance[term]:0}%</td></tr>`;
                    tbody.innerHTML += r;
                });
            }
        }
        window.calcRow = function(el) {
            const row = el.closest('tr');
            const qs = Array.from(row.querySelectorAll('.q-input')).map(i => i.value);
            const p = parseFloat(row.querySelector('.p-input').value)||0;
            const e = parseFloat(row.querySelector('.e-input').value)||0;
            const a = parseFloat(row.querySelector('.att-score').innerText)||0;
            let sum=0, cnt=0;
            qs.forEach(v => {if(v!==""){sum+=parseFloat(v); cnt++;}});
            if(cnt===0 && p===0 && e===0) return; 
            const wQ = globalWeights.quiz / 100;
            const wP = globalWeights.project / 100;
            const wE = globalWeights.exam / 100;
            const wA = globalWeights.attendance / 100;
            const final = Math.round(((cnt>0?sum/cnt:0)*wQ) + (p*wP) + (e*wE) + (a*wA));
            const cell = row.querySelector('.grade-cell');
            cell.innerText = final;
            if(final<75) cell.classList.add('failing-grade'); else cell.classList.remove('failing-grade');
        }
        function getAttDropdown(v) {
            const c = v==='Present'?'att-present':v==='Absent'?'att-absent':v==='Late'?'att-late':v==='Excused'?'att-excused':'';
            return `<select class="att-select ${c}" onchange="this.className='att-select '+ (this.value==='Present'?'att-present':this.value==='Absent'?'att-absent':this.value==='Late'?'att-late':this.value==='Excused'?'att-excused':''); calcAtt(this)">
                <option value="" ${v===''?'selected':''}></option>
                <option value="Present" ${v==='Present'?'selected':''}>P</option>
                <option value="Late" ${v==='Late'?'selected':''}>L</option>
                <option value="Excused" ${v==='Excused'?'selected':''}>E</option>
                <option value="Absent" ${v==='Absent'?'selected':''}>A</option></select>`;
        }
        window.calcAtt = function(el) {
            const row = el.closest('tr');
            const sels = row.querySelectorAll('select');
            const headers = document.querySelectorAll('.date-header-input');
            let pts=0, max=0;
            sels.forEach((s,i) => {
                if(headers[i] && headers[i].value.trim()!=="" && s.value !== "") { max++; if(s.value!=='Absent') pts++; }
            });
            row.querySelector('.att-total').innerText = (max>0?Math.round((pts/max)*100):0) + "%";
        }
        window.addDateColumn = function() {
            existingDates.push(""); 
            renderTable(currentStudents, 'attendance', currentTerm); 
        }
        window.saveAttendance = async function() {
            const batch = window.writeBatch(window.db);
            const headers = document.querySelectorAll('.date-header-input');
            document.querySelectorAll('#table-body tr').forEach(r => {
                const id = r.getAttribute('data-id');
                const log = {};
                r.querySelectorAll('select').forEach((s,i) => { if(headers[i].value.trim() && s.value) { log[headers[i].value.trim()] = s.value; } });
                const tot = parseInt(r.querySelector('.att-total').innerText)||0;
                const up = {}; up[`attendance_logs.${currentTerm}`]=log; up[`attendance.${currentTerm}`]=tot;
                batch.update(window.doc(window.db,"students",id), up);
            });
            await batch.commit(); showToast("Attendance Saved");
        }
        window.saveScores = async function() {
            const batch = window.writeBatch(window.db);
            document.querySelectorAll('#table-body tr').forEach(r => {
                const id = r.getAttribute('data-id');
                const qs = r.querySelectorAll('.q-input');
                const up = {};
                up[`scores.${currentTerm}.q1`]=qs[0].value; up[`scores.${currentTerm}.q2`]=qs[1].value;
                up[`scores.${currentTerm}.q3`]=qs[2].value; up[`scores.${currentTerm}.q4`]=qs[3].value;
                up[`scores.${currentTerm}.q5`]=qs[4].value; up[`scores.${currentTerm}.proj`]=r.querySelector('.p-input').value;
                up[`scores.${currentTerm}.exam`]=r.querySelector('.e-input').value; up[`grades.${currentTerm}`]=r.querySelector('.grade-cell').innerText;
                batch.update(window.doc(window.db,"students",id), up);
            });
            await batch.commit(); showToast("Scores Saved");
        }
        window.processCSV = async function() {
            const f = document.getElementById('csv-file'); if(!f.files.length) return showToast("Select File", "error");
            const r = new FileReader();
            
            // Progress Bar Init
            const pBar = document.getElementById('import-progress-bar');
            const pContainer = document.getElementById('import-progress-container');
            const pText = document.getElementById('progress-percent');
            pContainer.classList.remove('hidden');
            pBar.style.width = '0%'; pText.innerText = '0%';

            r.onload = async function(e) {
                const lines = e.target.result.split(/\r?\n/);
                let c=0;
                for(let i=1; i<lines.length; i++) {
                    const txt = lines[i]; if(!txt.trim()) continue;
                    const row = txt.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                    if(!row||row.length<5) continue;
                    const cl = (v)=>v?v.replace(/^"|"$/g,'').trim():'';
                    const uid=cl(row[0]), sec=cl(row[4]);
                    try {
                        await window.setDoc(window.doc(window.db,"students",uid+"_"+sec), {
                            uid:uid, password:cl(row[1]), name:cl(row[2]), subject:cl(row[3]), section:sec, course:cl(row[5]), status:cl(row[6])||'Active'
                        }, {merge:true});
                        c++;
                        // Update Progress
                        const percent = Math.round((i / lines.length) * 100);
                        pBar.style.width = percent + '%';
                        pText.innerText = percent + '%';
                    } catch(err){console.error(err);}
                }
                showToast(`Uploaded ${c} records`);
                document.getElementById('import-modal').classList.add('hidden');
                pContainer.classList.add('hidden'); // Hide progress
                await fetchSectionsForDropdown();
            };
            r.readAsText(f.files[0]);
        }
        
        // --- STUDENT FUNCTIONS ---
        function initStudentPortal() {
            if (allStudentSubjects.length === 0) return;
            const select = document.getElementById('student-subject-select');
            select.innerHTML = '';
            allStudentSubjects.forEach((sub, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = `${sub.subject} (${sub.section})`;
                select.appendChild(opt);
            });
            renderStudentPage(allStudentSubjects[0]);
        }
        window.switchStudentSubject = function() {
            const index = document.getElementById('student-subject-select').value;
            renderStudentPage(allStudentSubjects[index]);
        }
        function renderStudentPage(data) {
            activeStudentSubject = data;
            document.getElementById('student-name-display').innerText = `${data.name} | ${data.course}`;
            document.getElementById('lbl-prelim-w').innerText = `${globalWeights.prelim}%`;
            document.getElementById('lbl-mid-w').innerText = `${globalWeights.midterm}%`;
            document.getElementById('lbl-fin-w').innerText = `${globalWeights.finals}%`;

            const g = data.grades || {};
            const p = parseFloat(g.prelim) || null;
            const m = parseFloat(g.midterm) || null;
            const f = parseFloat(g.finals) || null;

            document.getElementById('s-prelim').innerText = p !== null ? p : "--";
            document.getElementById('s-midterm').innerText = m !== null ? m : "--";
            document.getElementById('s-finals').innerText = f !== null ? f : "--";

            const wP = globalWeights.prelim/100;
            const wM = globalWeights.midterm/100;
            const wF = globalWeights.finals/100;
            let cardGrade = null;
            if (p && m && f) {
                cardGrade = Math.round((p * wP) + (m * wM) + (f * wF));
                document.getElementById('s-card').innerText = cardGrade;
            } else { document.getElementById('s-card').innerText = "--"; }
            
            showStudentTerm('prelim', document.querySelector('.nav-link.active'));
            document.getElementById('target-grade-input').value = "";
            document.getElementById('f-prelim-box').classList.add('hidden');
            document.getElementById('f-midterm-box').classList.add('hidden');
            document.getElementById('f-finals-box').classList.add('hidden');
            
            // Initial call to hide or reset progress bars
            updateProgressBars(null); 
        }
        window.showStudentTerm = function(term, btn) {
            if (!activeStudentSubject) return;
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const container = document.getElementById('student-term-detail');
            const data = activeStudentSubject;
            const scores = (data.scores && data.scores[term]) ? data.scores[term] : {};
            const att = (data.attendance && data.attendance[term]) ? data.attendance[term] : 0;
            const logs = (data.attendance_logs && data.attendance_logs[term]) ? data.attendance_logs[term] : {};
            
            container.innerHTML = `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card p-3 h-100 bg-white border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">Scores</h6>
                            <table class="table table-sm table-borderless small">
                                <tbody>
                                    <tr><td class="text-muted">Quiz 1</td><td class="fw-bold text-end">${scores.q1 || '-'}</td></tr>
                                    <tr><td class="text-muted">Quiz 2</td><td class="fw-bold text-end">${scores.q2 || '-'}</td></tr>
                                    <tr><td class="text-muted">Quiz 3</td><td class="fw-bold text-end">${scores.q3 || '-'}</td></tr>
                                    <tr><td class="text-muted">Quiz 4</td><td class="fw-bold text-end">${scores.q4 || '-'}</td></tr>
                                    <tr><td class="text-muted">Quiz 5</td><td class="fw-bold text-end">${scores.q5 || '-'}</td></tr>
                                    <tr class="border-top"><td class="text-dark"><strong>Quiz Avg</strong></td><td class="text-primary text-end"><strong>${calcQuizAvg(scores)}</strong></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3 h-100 bg-white border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">Components</h6>
                            <table class="table table-sm table-borderless small">
                                <tbody>
                                    <tr><td class="text-muted">Project</td><td class="fw-bold text-end">${scores.proj || '-'}</td></tr>
                                    <tr><td class="text-muted">Exam</td><td class="fw-bold text-end">${scores.exam || '-'}</td></tr>
                                    <tr><td class="text-muted">Attendance</td><td class="fw-bold text-end d-flex align-items-center justify-content-end gap-2">${att} <button class="btn btn-outline-primary icon-btn" style="width:24px; height:24px; font-size:12px;" onclick="showAttModal('${term}')"><i class="bi bi-list-task"></i></button></td></tr>
                                    <tr class="table-primary rounded"><td class="p-2 text-primary"><strong>${term.toUpperCase()}</strong></td><td class="p-2 text-primary text-end"><strong>${(data.grades && data.grades[term]) || '-'}</strong></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            window.currentLogs = logs;
        }
        function calcQuizAvg(s) {
            let sum=0, c=0;
            ['q1','q2','q3','q4','q5'].forEach(k => {if(s[k]){sum+=parseFloat(s[k]); c++;}});
            return c>0 ? (sum/c).toFixed(1) : '-';
        }
        window.showAttModal = function(term) {
            const body = document.getElementById('att-modal-body');
            const logs = window.currentLogs || {};
            if (Object.keys(logs).length === 0) {
                body.innerHTML = "<div class='p-3 text-center text-muted small'>No records found.</div>";
            } else {
                let html = "<table class='table table-hover mb-0 small'><thead class='table-light'><tr><th class='ps-4'>Date</th><th>Status</th></tr></thead><tbody>";
                Object.keys(logs).sort().forEach(d => {
                    const st = logs[d];
                    const color = st==='Present'?'text-success':st==='Absent'?'text-danger':st==='Late'?'text-warning':'text-primary';
                    html += `<tr><td class='ps-4'>${d}</td><td class="${color} fw-bold">${st}</td></tr>`;
                });
                html += "</tbody></table>";
                body.innerHTML = html;
            }
            new bootstrap.Modal(document.getElementById('attModal')).show();
        }
        
        // --- TARGET CALCULATION LOGIC UPDATED ---
        window.calculateForecast = function() {
            const target = parseFloat(document.getElementById('target-grade-input').value);
            
            // Helper: Returns numeric value or null if missing (treated as not yet entered)
            const getVal = (id) => {
                const txt = document.getElementById(id).innerText;
                return (txt === "--" || isNaN(parseFloat(txt))) ? null : parseFloat(txt);
            };

            const p = getVal('s-prelim');
            const m = getVal('s-midterm');
            const f = getVal('s-finals'); // Usually missing if we are forecasting
            
            const prelimBox = document.getElementById('f-prelim-box');
            const midBox = document.getElementById('f-midterm-box');
            const finBox = document.getElementById('f-finals-box');
            
            const prelimVal = document.getElementById('f-prelim');
            const midVal = document.getElementById('f-midterm');
            const finVal = document.getElementById('f-finals');

            // Reset UI
            prelimBox.classList.add('hidden'); midBox.classList.add('hidden'); finBox.classList.add('hidden');
            
            // Pass target to progress bars even if target is 0/empty to reset them
            updateProgressBars(target);

            if (!target) return; 

            const wP = globalWeights.prelim/100;
            const wM = globalWeights.midterm/100;
            const wF = globalWeights.finals/100;
            
            // --- SCENARIO 1: NO GRADES YET (Start of Semester) ---
            if (p === null && m === null) {
                // Target = Needed * (wP + wM + wF)  => Needed = Target / 1
                const needed = target; 
                const rounded = Math.ceil(needed);
                
                // Show needed for ALL terms
                prelimBox.classList.remove('hidden'); midBox.classList.remove('hidden'); finBox.classList.remove('hidden');
                
                prelimVal.innerText = formatNeeded(rounded);
                midVal.innerText = formatNeeded(rounded);
                finVal.innerText = formatNeeded(rounded);
                return;
            }

            // --- SCENARIO 2: PRELIM EXISTS, MIDTERM MISSING ---
            if (p !== null && m === null) {
                // Target = (P * wP) + (Needed * (wM + wF))
                const currentPoints = p * wP;
                const remainingWeight = wM + wF;
                const needed = (target - currentPoints) / remainingWeight;
                const rounded = Math.ceil(needed);
                
                midBox.classList.remove('hidden'); finBox.classList.remove('hidden');
                midVal.innerText = formatNeeded(rounded);
                finVal.innerText = formatNeeded(rounded);
                return;
            }

            // --- SCENARIO 3: PRELIM & MIDTERM EXIST, FINALS MISSING ---
            if (p !== null && m !== null) {
                // Target = (P * wP) + (M * wM) + (Needed * wF)
                const currentPoints = (p * wP) + (m * wM);
                const needed = (target - currentPoints) / wF;
                const rounded = Math.ceil(needed);
                
                finBox.classList.remove('hidden');
                finVal.innerText = formatNeeded(rounded);
                return;
            }
        }

        function formatNeeded(val) {
            if (val > 100) return "Impossible";
            if (val < 0) return 0;
            return val;
        }

        function updateProgressBars(target) {
            const ids = ['prelim', 'midterm', 'finals', 'card'];
            
            ids.forEach(term => {
                const box = document.getElementById(`p-${term}-bar-box`);
                const bar = document.getElementById(`p-${term}-bar`);
                const valTxt = document.getElementById(`s-${term}`).innerText;
                
                // Only show progress if target is set AND we have a grade (for Card Grade progress is useful)
                // OR if we want to show progress towards target even if grade is 0 (shows empty bar).
                // Let's show it if target exists.
                
                if (!target || valTxt === "--") {
                    box.classList.add('hidden');
                    return;
                }

                box.classList.remove('hidden');
                const current = parseFloat(valTxt) || 0;
                
                // Calculate percentage of target achieved. 
                // e.g. Target 90, Current 45 -> 50%
                // BUT logically, for a term grade, if I have 85 and target is 90, I am "close".
                // Let's make the bar represent the grade value itself relative to 100, 
                // but colored based on proximity to target.
                
                // Actually user asked: "how near the student is in achieving the calculated should-be term grade"
                // This implies comparing Current Grade vs Target Grade.
                
                let percent = (current / target) * 100;
                if (percent > 100) percent = 100;
                
                bar.style.width = percent + "%";
                
                // Color Logic
                if (current >= target) {
                    bar.style.backgroundColor = "var(--success-green)"; // On track
                } else if (current >= target - 5) {
                    bar.style.backgroundColor = "var(--warning-orange)"; // Close
                } else {
                    bar.style.backgroundColor = "var(--danger-red)"; // Far behind
                }
            });
        }
    </script>
</body>
</html>
