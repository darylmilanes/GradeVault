<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Prevent Auto Zoom on Mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GradeVault Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-body: #fafeff;
            --primary-blue: #004080;
            --primary-dark: #002a55;
            --text-main: #2c3e50;
            --text-muted: #6c757d;
            --border-light: #e2e8f0;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --warning-orange: #fd7e14;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden; 
        }

        /* Prevent Zoom on inputs for Mobile */
        @media screen and (max-width: 768px) {
            input, select, textarea { font-size: 16px !important; }
        }

        /* --- BACKGROUND ANIMATION --- */
        .background-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            overflow: hidden; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .bg-square {
            position: absolute; bottom: -100px; background: rgba(255, 255, 255, 0.6);
            border-radius: 10px; animation: floatUp 15s infinite linear;
        }
        .bg-square:nth-child(1) { width: 80px; height: 80px; left: 10%; animation-duration: 12s; }
        .bg-square:nth-child(2) { width: 40px; height: 40px; left: 20%; animation-duration: 18s; animation-delay: 2s; }
        .bg-square:nth-child(3) { width: 100px; height: 100px; left: 35%; animation-duration: 25s; animation-delay: 4s; }
        .bg-square:nth-child(4) { width: 50px; height: 50px; left: 50%; animation-duration: 15s; }
        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            20% { opacity: 0.8; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        /* --- Custom Toast (LEFT SIDE) --- */
        #toast-container { position: fixed; top: 20px; left: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .custom-toast { background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); padding: 15px 20px; min-width: 300px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; border-left: 5px solid var(--primary-blue); }
        .custom-toast.success { border-left-color: var(--success-green); }
        .custom-toast.error { border-left-color: var(--danger-red); }
        @keyframes slideIn { from { transform: translateX(-120%); } to { transform: translateX(0); } } /* Slide from left */
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Navbar */
        .navbar { background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark)) !important; box-shadow: 0 4px 12px rgba(0, 64, 128, 0.15); padding: 0.8rem 0; }
        .navbar-brand { color: white !important; font-weight: 800; font-size: 1.3rem; display: flex; align-items: center; gap: 12px; }
        .logo-box { background: rgba(255,255,255,0.2); border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .icon-btn { border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; padding: 0; }

        /* General UI */
        .card { border: none; border-radius: 12px; box-shadow: var(--card-shadow); background-color: white; margin-bottom: 1rem; }
        .hidden { display: none !important; }
        .btn { border-radius: 8px; font-weight: 500; transition: all 0.2s; }
        
        /* Tables */
        .table-responsive { border-radius: 12px; border: 1px solid var(--border-light); overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table th { font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; padding: 12px; white-space: nowrap; }
        .table td { padding: 10px 12px; vertical-align: middle; white-space: nowrap; }
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 10; border-right: 2px solid var(--border-light) !important; color: var(--primary-blue); font-weight: 600; }

        /* --- STUDENT PORTAL SPECIFIC (Restored) --- */
        .grade-card { 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; padding: 25px 15px; text-align: center; 
            border: 1px solid var(--border-light); border-top: 4px solid var(--primary-blue);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .grade-card:hover { transform: translateY(-3px); box-shadow: var(--hover-shadow); }
        .grade-value { font-size: 2.5rem; font-weight: 800; color: var(--primary-blue); line-height: 1.1; margin: 10px 0; }
        .grade-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; }
        
        .forecast-box { 
            background-color: #fff8f0; border: 1px dashed var(--warning-orange); 
            padding: 4px 10px; border-radius: 6px; margin-top: 10px; 
            color: #856404; font-size: 0.8rem; display: inline-block;
        }
        .forecast-val { font-weight: 800; color: var(--warning-orange); }

        .card-progress-container { width: 100%; background-color: #e9ecef; border-radius: 4px; height: 6px; margin-top: 15px; overflow: hidden; }
        .card-progress-bar { height: 100%; background-color: var(--success-green); width: 0%; transition: width 0.5s ease; }

        .target-calc-container { background: linear-gradient(to right, #ffffff, #f8faff); border-radius: 12px; }
        
        /* Washed out placeholder for My Goal */
        #target-grade-input::placeholder { color: #cbd5e1; opacity: 0.5; font-weight: 400; }

        .nav-tabs { border-bottom: 2px solid var(--border-light); margin-bottom: 20px; flex-wrap: nowrap; overflow-x: auto; }
        .nav-link { color: var(--text-muted); font-weight: 600; border: none; padding: 12px 20px; margin-bottom: -2px; white-space: nowrap; border-radius: 8px 8px 0 0; transition: all 0.2s; }
        .nav-link:hover { color: var(--primary-blue); background: rgba(0,0,0,0.02); }
        .nav-link.active { color: var(--primary-blue); border-bottom: 3px solid var(--primary-blue); background: #f0f7ff; font-weight: 800; }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }


        /* --- MOBILE ENTRY APP INTERFACE --- */
        #mobile-entry-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f8f9fa; z-index: 1080;
            display: flex; flex-direction: column;
        }
        .mobile-header {
            background: white; padding: 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10;
        }
        .mobile-body { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .entry-card {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .entry-name { font-weight: 700; color: #333; font-size: 1rem; }
        .entry-uid { font-size: 0.75rem; color: #999; }
        
        /* Scores Input Mobile */
        .mobile-score-input {
            width: 80px; height: 45px; font-size: 1.2rem; font-weight: bold;
            text-align: center; border: 1px solid #ddd; border-radius: 8px;
            background: #f8f9fa; color: var(--primary-blue);
        }
        .mobile-score-input:focus { border-color: var(--primary-blue); background: white; outline: none; }

        /* Attendance Buttons Mobile */
        .att-btn-group { display: flex; gap: 5px; }
        .att-btn {
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid #eee;
            font-weight: 700; background: white; color: #ccc;
            display: flex; align-items: center; justify-content: center;
        }
        .att-btn.active[data-val="Present"] { background: #d4edda; color: var(--success-green); border-color: var(--success-green); }
        .att-btn.active[data-val="Late"] { background: #fff3cd; color: var(--warning-orange); border-color: var(--warning-orange); }
        .att-btn.active[data-val="Excused"] { background: #cce5ff; color: var(--primary-blue); border-color: var(--primary-blue); }
        .att-btn.active[data-val="Absent"] { background: #f8d7da; color: var(--danger-red); border-color: var(--danger-red); }

        /* Selection Grids */
        .comp-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .comp-btn {
            padding: 15px; border: 1px solid #eee; border-radius: 8px; background: white;
            text-align: center; font-weight: 600; color: var(--text-main); transition: 0.2s;
        }
        .comp-btn:hover { border-color: var(--primary-blue); background: #f0f7ff; }
        .comp-btn.has-data { background-color: #d4edda; border-color: var(--success-green); color: var(--success-green); }

        /* Existing Styles reused */
        #login-section { min-height: 80vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-container { width: 100%; max-width: 400px; padding: 35px 30px; background: rgba(255, 255, 255, 0.95); border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 64, 128, 0.15); border-top: 6px solid var(--primary-blue); }
        .grade-cell { font-weight: 800; }
        
        /* Removed old failing grade style in favor of new JS color logic */

        /* Media Queries for Responsive */
        @media (max-width: 991px) {
            .navbar-brand { font-size: 1.1rem; }
            .col-sm-6 { width: 50%; }
            .target-calc-container { flex-direction: column; align-items: flex-start !important; }
            .target-calc-input { width: 100% !important; margin-top: 10px; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div class="background-animation">
        <div class="bg-square"></div><div class="bg-square"></div><div class="bg-square"></div>
        <div class="bg-square"></div><div class="bg-square"></div>
    </div>

    <div id="toast-container"></div>

    <!-- 1. LOGIN SECTION -->
    <div id="login-section">
        <div class="login-container">
            <h3 class="text-center mb-4" style="font-weight: 800; color: var(--primary-blue); display:flex; align-items:center; justify-content:center; gap:10px;">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:40px; height:40px; font-size:1.2rem;">
                    <i class="bi bi-mortarboard-fill"></i>
                </div>
                <div>GradeVault</div>
            </h3>
            <div class="mb-3">
                <label class="form-label">User ID / Email</label>
                <input type="text" id="login-uid" class="form-control" placeholder="ID or Email">
            </div>
            <div class="mb-4">
                <label class="form-label">Password</label>
                <input type="password" id="login-pass" class="form-control" placeholder="••••••••" onkeydown="if(event.key==='Enter') handleLogin()">
            </div>
            <button id="btn-login" onclick="handleLogin()" class="btn btn-primary w-100 py-2 fw-bold d-flex align-items-center justify-content-center gap-2">
                <span>Sign In</span>
                <div id="login-spinner" class="spinner-border spinner-border-sm text-white d-none" role="status"></div>
            </button>
        </div>
    </div>

    <!-- 2. TEACHER PORTAL -->
    <div id="teacher-section" class="hidden">
        <nav class="navbar navbar-expand-lg mb-3">
            <div class="container-fluid px-3 d-flex justify-content-between">
                <span class="navbar-brand">
                    <div class="logo-box"><i class="bi bi-mortarboard-fill"></i></div>
                    <span class="brand-text">GradeVault</span>
                    <span class="brand-subtitle ms-2 small opacity-75">Teacher</span>
                </span>
                <button onclick="logout()" class="btn btn-outline-light icon-btn" title="Sign Out"><i class="bi bi-power"></i></button>
            </div>
        </nav>
        <div class="container-fluid">
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <h6 class="mb-0 text-primary fw-bold">Class Management</h6>
                            <div class="d-flex gap-2">
                                <button onclick="document.getElementById('import-modal').classList.remove('hidden')" class="btn btn-sm btn-outline-secondary fw-bold">
                                    <i class="bi bi-folder-plus"></i> <span class="d-none d-md-inline">Import</span>
                                </button>
                                <button onclick="openSettingsModal()" class="btn btn-sm btn-outline-primary fw-bold">
                                    <i class="bi bi-gear"></i> <span class="d-none d-md-inline">Config</span>
                                </button>
                            </div>
                        </div>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3 col-6">
                                <label class="form-label small fw-bold text-muted">Term</label>
                                <select id="term-select" class="form-select"><option value="prelim">Prelim</option><option value="midterm">Midterm</option><option value="finals">Finals</option></select>
                            </div>
                            <div class="col-md-3 col-6">
                                <label class="form-label small fw-bold text-muted">Section</label>
                                <select id="section-select" class="form-select"><option value="">Loading...</option></select>
                            </div>
                            <div class="col-md-3 col-12">
                                <label class="form-label small fw-bold text-muted">Action</label>
                                <select id="view-mode" class="form-select" onchange="toggleTeacherButtons()">
                                    <option value="list">View Student List</option>
                                    <option value="scores">Manage Scores</option>
                                    <option value="attendance">Manage Attendance</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-12 d-flex gap-2">
                                <!-- Dynamic Buttons appear here based on view mode -->
                                <button id="btn-load-list" onclick="loadClassList()" class="btn btn-primary w-100 fw-bold">
                                    <span class="d-md-none d-xl-inline">Load List</span>
                                    <span class="d-none d-md-inline d-xl-none">Load</span>
                                </button>
                                <button id="btn-log-records" onclick="openLogSelectionModal()" class="btn btn-success w-100 fw-bold hidden"><i class="bi bi-pencil-square"></i> Log</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="results-area" class="hidden">
                <div class="card p-0 overflow-hidden shadow-sm">
                    <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                        <h6 id="table-title" class="m-0 fw-bold text-primary">Class List</h6>
                        <span class="badge bg-light text-dark border">Read Only View</span>
                    </div>
                    <div class="table-responsive border-0">
                        <table class="table table-hover mb-0" id="data-table">
                            <thead id="table-head"></thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. MOBILE ENTRY APP (Full Screen Overlay) -->
    <div id="mobile-entry-page" class="hidden">
        <div class="mobile-header">
            <div>
                <div class="small text-muted fw-bold" id="mobile-subtitle">SECTION - TERM</div>
                <div class="h5 mb-0 fw-bold text-primary" id="mobile-title">Component Name</div>
            </div>
            <button onclick="closeMobileEntry()" class="btn btn-light fw-bold text-muted border">Done</button>
        </div>
        
        <div class="mobile-body" id="mobile-entry-list">
            <!-- Dynamic Content -->
        </div>

        <div class="p-3 bg-white border-top fixed-bottom shadow-lg d-flex justify-content-between align-items-center">
            <span class="small text-muted" id="mobile-status">Ready to save.</span>
            <button onclick="saveMobileBatch()" class="btn btn-primary px-4 fw-bold shadow">
                <i class="bi bi-cloud-upload"></i> Save All
            </button>
        </div>
    </div>

    <!-- 4. STUDENT PORTAL -->
    <div id="student-section" class="hidden">
        <nav class="navbar navbar-expand-lg mb-4">
            <div class="container px-3">
                <div class="row w-100 align-items-center gx-0">
                    <div class="col-lg-6 col-12 d-flex flex-column mb-2 mb-lg-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="navbar-brand">
                                <div class="logo-box"><i class="bi bi-mortarboard-fill"></i></div>
                                <span class="brand-text">GradeVault</span>
                                <span class="brand-subtitle">Student</span>
                            </span>
                            <button onclick="logout()" class="btn btn-outline-light icon-btn d-lg-none"><i class="bi bi-power"></i></button>
                        </div>
                        <div class="text-white small fw-medium" id="student-name-display" style="line-height:1.2;">Loading...</div>
                    </div>
                    <div class="col-lg-6 col-12 d-flex justify-content-lg-end justify-content-center align-items-center gap-3">
                        <select id="student-subject-select" class="form-select form-select-sm" onchange="switchStudentSubject()"></select>
                        <button onclick="logout()" class="btn btn-outline-light icon-btn d-none d-lg-flex"><i class="bi bi-power"></i></button>
                    </div>
                </div>
            </div>
        </nav>
        
        <div class="container px-3">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card p-3 border-0 shadow-sm" style="background: linear-gradient(to right, #ffffff, #f8faff);">
                        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-3 target-calc-container">
                            <div class="d-flex align-items-center gap-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:42px; height:42px; font-size:1.3rem;">
                                    <i class="bi bi-calculator"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold text-primary">Target Calculator</h6>
                                    <p class="mb-0 text-muted small">Set goal to see required grades.</p>
                                </div>
                            </div>
                            <div class="target-calc-input d-flex align-items-center gap-2">
                                <span class="fw-bold text-muted small">MY GOAL:</span>
                                <input type="number" id="target-grade-input" class="form-control fw-bold text-primary text-center" style="width: 80px;" placeholder="90" oninput="calculateForecast()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4 g-3">
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card grade-card">
                        <div class="grade-label">Prelim</div>
                        <div class="grade-value" id="s-prelim">--</div>
                        <div class="badge bg-light text-muted border fw-normal" style="font-size:0.7em" id="lbl-prelim-w">25%</div>
                        <div class="forecast-box hidden" id="f-prelim-box"><div class="forecast-val" id="f-prelim">--</div></div>
                        <div class="card-progress-container hidden" id="p-prelim-bar-box"><div class="card-progress-bar" id="p-prelim-bar"></div></div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card grade-card">
                        <div class="grade-label">Midterm</div>
                        <div class="grade-value" id="s-midterm">--</div>
                        <div class="badge bg-light text-muted border fw-normal" style="font-size:0.7em" id="lbl-mid-w">35%</div>
                        <div class="forecast-box hidden" id="f-midterm-box"><div class="forecast-val" id="f-midterm">--</div></div>
                        <div class="card-progress-container hidden" id="p-midterm-bar-box"><div class="card-progress-bar" id="p-midterm-bar"></div></div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card grade-card">
                        <div class="grade-label">Finals</div>
                        <div class="grade-value" id="s-finals">--</div>
                        <div class="badge bg-light text-muted border fw-normal" style="font-size:0.7em" id="lbl-fin-w">40%</div>
                        <div class="forecast-box hidden" id="f-finals-box"><div class="forecast-val" id="f-finals">--</div></div>
                        <div class="card-progress-container hidden" id="p-finals-bar-box"><div class="card-progress-bar" id="p-finals-bar"></div></div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card grade-card" id="card-grade-container" style="border-top-color: var(--success-green); background: #f0fff4;">
                        <div class="grade-label" id="card-grade-label">Total</div>
                        <div class="grade-value" id="s-card">--</div>
                        <div class="small text-muted mt-1" style="font-size:0.7em">Final Grade</div>
                        <div class="card-progress-container hidden" id="p-card-bar-box"><div class="card-progress-bar" id="p-card-bar"></div></div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="card p-3">
                        <h6 class="mb-3 fw-bold text-primary">Breakdown</h6>
                        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                            <li class="nav-item"><button class="nav-link active" onclick="showStudentTerm('prelim', this)">Prelim</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="showStudentTerm('midterm', this)">Midterm</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="showStudentTerm('finals', this)">Finals</button></li>
                        </ul>
                        <div id="student-term-detail" class="fade-in"><p class="text-muted text-center py-4 small">Select a term...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- 1. Settings -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h6 class="modal-title fw-bold">⚙️ Configuration</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-info small mb-3">
                        <strong>Note:</strong> Defaults are set to match the standard grading policy:
                        <ul>
                            <li>Quizzes: 20%, Project: 30%, Exam: 40%, Att: 10%</li>
                            <li>Prelim: 25%, Midterm: 35%, Finals: 40%</li>
                        </ul>
                    </div>
                    <h6 class="text-primary fw-bold text-uppercase small mb-3">Component Weights (%)</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-6"><label class="form-label small">Quizzes</label><input type="number" id="w-quiz" class="form-control"></div>
                        <div class="col-6"><label class="form-label small">Projects</label><input type="number" id="w-proj" class="form-control"></div>
                        <div class="col-6"><label class="form-label small">Exams</label><input type="number" id="w-exam" class="form-control"></div>
                        <div class="col-6"><label class="form-label small">Attendance</label><input type="number" id="w-att" class="form-control"></div>
                    </div>
                    <h6 class="text-primary fw-bold text-uppercase small mb-3">Term Weights (%)</h6>
                    <div class="row g-3">
                        <div class="col-4"><label class="form-label small">Prelim</label><input type="number" id="w-prelim" class="form-control"></div>
                        <div class="col-4"><label class="form-label small">Midterm</label><input type="number" id="w-mid" class="form-control"></div>
                        <div class="col-4"><label class="form-label small">Finals</label><input type="number" id="w-fin" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer bg-light p-2">
                    <button type="button" class="btn btn-primary w-100" onclick="saveSettings()">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Import CSV -->
    <div id="import-modal" class="card p-4 hidden shadow-lg" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:400px; z-index:1050; border-top: 5px solid var(--primary-blue);">
        <h6 class="mb-3 fw-bold">Import Student Data</h6>
        <div class="mb-3">
            <input type="file" id="csv-file" accept=".csv" class="form-control">
            <div class="form-text small">Select formatted CSV.</div>
        </div>
        <div id="import-progress-container" class="hidden mb-3">
            <div class="d-flex justify-content-between small mb-1"><span>Uploading...</span><span id="progress-percent">0%</span></div>
            <div class="progress"><div id="import-progress-bar" class="progress-bar" style="width: 0%"></div></div>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <button onclick="document.getElementById('import-modal').classList.add('hidden')" class="btn btn-light btn-sm">Cancel</button>
            <button onclick="processCSV()" class="btn btn-primary btn-sm">Upload</button>
        </div>
    </div>

    <!-- 3. Attendance View Modal (Student Side) -->
    <div class="modal fade" id="attModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content border-0">
                <div class="modal-header bg-light py-2">
                    <h6 class="modal-title fw-bold text-primary">Attendance Log</h6>
                    <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" id="att-modal-body"></div>
            </div>
        </div>
    </div>

    <!-- 4. Score Selection Modal (Teacher Side) -->
    <div class="modal fade" id="scoreSelectModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header bg-primary text-white">
                    <h6 class="modal-title fw-bold">Select Component to Log</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <p class="small text-muted mb-3">Green items have existing data.</p>
                    <div class="comp-grid" id="score-comp-grid">
                        <!-- Dynamic Buttons -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Date Selection Modal (Teacher Side) -->
    <div class="modal fade" id="dateSelectModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header bg-primary text-white">
                    <h6 class="modal-title fw-bold">Select Date to Log</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Add New Date</label>
                        <div class="d-flex gap-2">
                            <input type="text" id="new-att-date" class="form-control" placeholder="e.g. 10/25">
                            <button onclick="launchMobileEntry('attendance', document.getElementById('new-att-date').value)" class="btn btn-success fw-bold">Go</button>
                        </div>
                    </div>
                    <hr>
                    <label class="form-label small fw-bold">Edit Existing Date</label>
                    <div class="list-group" id="date-list-group">
                        <!-- Dynamic List -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyALyoSZFrB9odSuydyDvRkVGCDdDQa0Ub8",
          authDomain: "gradevault-app.firebaseapp.com",
          projectId: "gradevault-app",
          storageBucket: "gradevault-app.firebasestorage.app",
          messagingSenderId: "538075460552",
          appId: "1:538075460552:web:1175068265c9ffe78d86fd"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.collection = collection; window.doc = doc; window.setDoc = setDoc; window.getDoc = getDoc;
        window.getDocs = getDocs; window.query = query; window.where = where; window.writeBatch = writeBatch;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword; window.signOut = signOut;

        // --- AUTH PERSISTENCE LOGIC ---
        // Check for Admin Session
        onAuthStateChanged(window.auth, async (user) => {
            if (user && user.uid === ADMIN_UID) {
                // Restore Admin Session
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('teacher-section').classList.remove('hidden');
                await fetchSettings();
                await fetchSectionsForDropdown();
                showToast("Session Restored (Admin)");
            }
        });

        // Check for Student Session (LocalStorage)
        const storedStudentUID = localStorage.getItem('gv_student_uid');
        if (storedStudentUID) {
            // Restore Student Session
            restoreStudentSession(storedStudentUID);
        }

        async function restoreStudentSession(uid) {
            try {
                await fetchSettings();
                // Re-fetch student data based on stored UID
                const q = query(collection(window.db, "students"), where("uid", "==", uid));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    allStudentSubjects = [];
                    snapshot.forEach(doc => { if (doc.data().status !== "Dropped") allStudentSubjects.push(doc.data()); });
                    
                    if (allStudentSubjects.length > 0) {
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('student-section').classList.remove('hidden');
                        initStudentPortal();
                        showToast("Session Restored");
                    }
                }
            } catch (e) {
                console.error("Failed to restore student session", e);
                localStorage.removeItem('gv_student_uid'); // Clear if invalid
            }
        }
    </script>

    <script>
        let currentStudents = []; 
        let currentTerm = "";
        let existingDates = [];
        let allStudentSubjects = [];
        let activeStudentSubject = null;
        
        let globalWeights = { 
            quiz: 20, 
            project: 30, 
            exam: 40, 
            attendance: 10, 
            prelim: 25, 
            midterm: 35, 
            finals: 40 
        };

        // For Mobile Entry
        let activeEntryType = null; // 'scores' or 'attendance'
        let activeEntryKey = null; // 'q1', 'exam', '10/25', 'att'
        let entryChanges = {}; // Stores temp changes before save

        const ADMIN_UID = "Xv71xkRee8grRRhpfO2WYKoQhEC2"; 

        // --- CALCULATION LOGIC ---
        
        function getAttendanceScore(student, term) {
            // 1. Try to get saved summary score first
            if (student.attendance && student.attendance[term] !== undefined && student.attendance[term] !== "") {
                return parseFloat(student.attendance[term]);
            }
            // 2. If no summary, try to calculate from logs on the fly
            if (student.attendance_logs && student.attendance_logs[term]) {
                const logs = student.attendance_logs[term];
                const dates = Object.keys(logs).filter(d => logs[d]); // Valid entries
                if (dates.length > 0) {
                    let presentCount = 0;
                    dates.forEach(d => { if (logs[d] !== 'Absent') presentCount++; });
                    return Math.round((presentCount / dates.length) * 100);
                }
            }
            // 3. Default to 0 if absolutely no data found
            return 0;
        }

        function calculatePeriodGrade(scores, attendanceScore) {
            // 1. Quizzes (20%)
            let qSum = 0;
            let qCount = 0;
            ['q1', 'q2', 'q3', 'q4', 'q5'].forEach(q => {
                const val = scores[q];
                if (val !== "" && val !== undefined && val !== null) {
                    qSum += parseFloat(val);
                    qCount++;
                }
            });
            const qAvg = qCount > 0 ? qSum / qCount : 0;
            const quizComp = qAvg * (globalWeights.quiz / 100);

            // 2. Project (30%)
            const projVal = parseFloat(scores.proj);
            const projComp = (!isNaN(projVal) ? projVal : 0) * (globalWeights.project / 100);

            // 3. Exam (40%)
            const examVal = parseFloat(scores.exam);
            const examComp = (!isNaN(examVal) ? examVal : 0) * (globalWeights.exam / 100);

            // 4. Attendance (10%)
            const attVal = parseFloat(attendanceScore);
            const attComp = (!isNaN(attVal) ? attVal : 0) * (globalWeights.attendance / 100);

            const total = quizComp + projComp + examComp + attComp;
            
            return total;
        }

        function calculateCardGrade(p, m, f) {
            if (p === null && m === null && f === null) return null;
            
            const wP = globalWeights.prelim / 100;
            const wM = globalWeights.midterm / 100;
            const wF = globalWeights.finals / 100;

            const pScore = p || 0;
            const mScore = m || 0;
            const fScore = f || 0;

            const finalGrade = (pScore * wP) + (mScore * wM) + (fScore * wF);
            return Math.round(finalGrade); // Return Integer
        }

        // --- NEW: Helper for Grade Coloring ---
        function getGradeStyling(grade) {
            if (grade === null || grade === "--" || grade === undefined) {
                return { color: 'var(--text-muted)', bg: '#fff', border: 'var(--border-light)' };
            }
            const g = parseFloat(grade);
            if (g < 74.5) return { color: '#c62828', bg: '#ffebee', border: '#ef9a9a' }; // Dark Red
            if (g < 79.5) return { color: '#ef6c00', bg: '#fff3e0', border: '#ffcc80' }; // Dark Orange
            if (g < 89.5) return { color: '#1565c0', bg: '#e3f2fd', border: '#90caf9' }; // Dark Blue
            return { color: '#2e7d32', bg: '#e8f5e9', border: '#a5d6a7' }; // Green
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            const icon = type === 'success' ? 'bi-check-circle-fill text-success' : 'bi-exclamation-triangle-fill text-danger';
            toast.innerHTML = `<i class="bi ${icon} toast-icon"></i><div class="toast-msg">${msg}</div>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 1500); // CHANGED to 1.5s
        }

        async function handleLogin() {
            const uidInput = document.getElementById('login-uid').value.trim();
            const passInput = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('btn-login');
            const spinner = document.getElementById('login-spinner');

            if (!uidInput || !passInput) { showToast("Enter credentials", "error"); return; }
            btn.disabled = true; spinner.classList.remove('d-none');
            await fetchSettings();

            try {
                if (uidInput.includes("@")) {
                    const userCredential = await window.signInWithEmailAndPassword(window.auth, uidInput, passInput);
                    if (userCredential.user.uid === ADMIN_UID) {
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('teacher-section').classList.remove('hidden');
                        await fetchSectionsForDropdown();
                        showToast("Welcome, Admin!");
                    } else { throw new Error("Access Denied"); }
                } else {
                    const q = window.query(window.collection(window.db, "students"), window.where("uid", "==", uidInput), window.where("password", "==", passInput));
                    const snapshot = await window.getDocs(q);
                    if (!snapshot.empty) {
                        allStudentSubjects = [];
                        snapshot.forEach(doc => { if (doc.data().status !== "Dropped") allStudentSubjects.push(doc.data()); });
                        if (allStudentSubjects.length === 0) throw new Error("No active subjects found.");
                        
                        localStorage.setItem('gv_student_uid', uidInput);

                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('student-section').classList.remove('hidden');
                        initStudentPortal();
                        showToast("Welcome Student!");
                    } else { throw new Error("Invalid Credentials"); }
                }
            } catch (error) { showToast(error.message, "error"); btn.disabled = false; spinner.classList.add('d-none'); }
        }

        function logout() { 
            window.signOut(window.auth);
            localStorage.removeItem('gv_student_uid');
            location.reload(); 
        }

        async function fetchSettings() {
            try {
                const docSnap = await window.getDoc(window.doc(window.db, "settings", "config"));
                if (docSnap.exists()) globalWeights = docSnap.data();
            } catch (e) { console.error(e); }
        }

        window.openSettingsModal = function() {
            document.getElementById('w-quiz').value = globalWeights.quiz;
            document.getElementById('w-proj').value = globalWeights.project;
            document.getElementById('w-exam').value = globalWeights.exam;
            document.getElementById('w-att').value = globalWeights.attendance;
            document.getElementById('w-prelim').value = globalWeights.prelim;
            document.getElementById('w-mid').value = globalWeights.midterm;
            document.getElementById('w-fin').value = globalWeights.finals;
            new bootstrap.Modal(document.getElementById('settingsModal')).show();
        }

        window.saveSettings = async function() {
            const newWeights = {
                quiz: parseFloat(document.getElementById('w-quiz').value),
                project: parseFloat(document.getElementById('w-proj').value),
                exam: parseFloat(document.getElementById('w-exam').value),
                attendance: parseFloat(document.getElementById('w-att').value),
                prelim: parseFloat(document.getElementById('w-prelim').value),
                midterm: parseFloat(document.getElementById('w-mid').value),
                finals: parseFloat(document.getElementById('w-fin').value)
            };
            if ((newWeights.quiz + newWeights.project + newWeights.exam + newWeights.attendance) !== 100) return showToast(`Components must be 100%`, "error");
            if ((newWeights.prelim + newWeights.midterm + newWeights.finals) !== 100) return showToast(`Term Weights must be 100%`, "error");
            
            try {
                await window.setDoc(window.doc(window.db, "settings", "config"), newWeights);
                globalWeights = newWeights;
                showToast("Configuration Saved");
                bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
                if(activeStudentSubject) renderStudentPage(activeStudentSubject);
            } catch (e) { showToast(e.message, "error"); }
        }

        function toggleTeacherButtons() {
            const mode = document.getElementById('view-mode').value;
            const btnLoad = document.getElementById('btn-load-list');
            const btnLog = document.getElementById('btn-log-records');
            
            if (mode === 'list') {
                btnLoad.classList.remove('hidden'); btnLoad.classList.add('w-100');
                btnLog.classList.add('hidden');
            } else {
                btnLoad.classList.remove('hidden'); btnLoad.classList.remove('w-100'); btnLoad.classList.add('w-50');
                btnLog.classList.remove('hidden'); btnLog.classList.add('w-50');
            }
        }

        async function fetchSectionsForDropdown() {
            const select = document.getElementById('section-select');
            try {
                const q = window.query(window.collection(window.db, "students"));
                const querySnapshot = await window.getDocs(q);
                const sections = new Set();
                querySnapshot.forEach(doc => { if(doc.data().section) sections.add(doc.data().section); });
                select.innerHTML = '<option value="">Select Section</option>';
                Array.from(sections).sort().forEach(sec => {
                    const opt = document.createElement('option'); opt.value = sec; opt.textContent = sec; select.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function loadClassList() {
            const section = document.getElementById('section-select').value;
            currentTerm = document.getElementById('term-select').value;
            const mode = document.getElementById('view-mode').value;
            if (!section) { showToast("Select a section", "error"); return; }
            
            const q = window.query(window.collection(window.db, "students"), window.where("section", "==", section));
            const snapshot = await window.getDocs(q);
            currentStudents = [];
            snapshot.forEach(doc => { let d = doc.data(); d.docID = doc.id; currentStudents.push(d); });
            currentStudents.sort((a, b) => a.name.localeCompare(b.name));
            
            const dateSet = new Set();
            currentStudents.forEach(s => {
                if (s.attendance_logs && s.attendance_logs[currentTerm]) 
                    Object.keys(s.attendance_logs[currentTerm]).forEach(d => dateSet.add(d));
            });
            existingDates = Array.from(dateSet).sort();
            
            renderTable(currentStudents, mode, currentTerm);
        }

        function renderTable(students, mode, term) {
            const tbody = document.getElementById('table-body');
            const thead = document.getElementById('table-head');
            document.getElementById('results-area').classList.remove('hidden');
            document.getElementById('table-title').innerText = `Section ${students[0]?.section || ''} | ${term.toUpperCase()}`;
            tbody.innerHTML = ''; thead.innerHTML = '';
            
            if (mode === 'list') {
                thead.innerHTML = `<tr><th>Student Name</th><th>User ID</th><th>Course</th><th>Status</th></tr>`;
                students.forEach(s => {
                    tbody.innerHTML += `<tr><td class="fw-bold text-primary">${s.name}</td><td>${s.uid}</td><td>${s.course}</td><td><span class="badge ${s.status === 'Active' ? 'bg-success' : 'bg-danger'}">${s.status}</span></td></tr>`;
                });
            } else if (mode === 'scores') {
                thead.innerHTML = `<tr><th class="sticky-col">Name</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Q5</th><th>Prj</th><th>Exm</th><th class="bg-light">Att</th><th class="bg-light">Grd</th></tr>`;
                students.forEach(s => {
                    if (s.status === "Dropped") return;
                    const sc = (s.scores && s.scores[term]) ? s.scores[term] : {};
                    const att = getAttendanceScore(s, term);
                    const calculatedGrade = calculatePeriodGrade(sc, att);
                    
                    // NEW: Apply Color Logic to Grade Cell
                    const style = getGradeStyling(calculatedGrade);
                    
                    tbody.innerHTML += `<tr><td class="sticky-col">${s.name}</td><td>${sc.q1||'-'}</td><td>${sc.q2||'-'}</td><td>${sc.q3||'-'}</td><td>${sc.q4||'-'}</td><td>${sc.q5||'-'}</td><td>${sc.proj||'-'}</td><td>${sc.exam||'-'}</td><td class="text-center">${att}</td><td class="grade-cell" style="color:${style.color}; font-weight:800;">${calculatedGrade.toFixed(2)}</td></tr>`;
                });
            } else if (mode === 'attendance') {
                let h = `<tr><th class="sticky-col">Name</th>`;
                existingDates.forEach(d => h += `<th>${d}</th>`);
                h += `<th class="bg-light">Total</th></tr>`;
                thead.innerHTML = h;
                students.forEach(s => {
                    if (s.status === "Dropped") return;
                    const logs = (s.attendance_logs && s.attendance_logs[term]) ? s.attendance_logs[term] : {};
                    let r = `<tr><td class="sticky-col">${s.name}</td>`;
                    existingDates.forEach(d => {
                         const val = logs[d] || "";
                         const color = val==='Present'?'text-success':val==='Absent'?'text-danger':val==='Late'?'text-warning':'text-primary';
                         r += `<td class="fw-bold ${color}">${val.substring(0,1)}</td>`;
                    });
                    const attVal = getAttendanceScore(s, term);
                    r += `<td class="text-center fw-bold">${attVal}</td></tr>`;
                    tbody.innerHTML += r;
                });
            }
        }

        window.openLogSelectionModal = async function() {
            const section = document.getElementById('section-select').value;
            if(!section) { showToast("Select Section first", "error"); return; }
            if(currentStudents.length === 0) await loadClassList();
            
            const mode = document.getElementById('view-mode').value;
            if (mode === 'scores') {
                renderScoreSelectionModal();
                new bootstrap.Modal(document.getElementById('scoreSelectModal')).show();
            } else if (mode === 'attendance') {
                renderDateSelectionModal();
                new bootstrap.Modal(document.getElementById('dateSelectModal')).show();
            }
        }

        function renderScoreSelectionModal() {
            const grid = document.getElementById('score-comp-grid');
            const components = ['q1','q2','q3','q4','q5','proj','exam'];
            const labels = {'q1':'Quiz 1','q2':'Quiz 2','q3':'Quiz 3','q4':'Quiz 4','q5':'Quiz 5','proj':'Project','exam':'Exam'};
            grid.innerHTML = '';
            
            components.forEach(comp => {
                let filledCount = 0;
                currentStudents.forEach(s => {
                    if (s.scores && s.scores[currentTerm] && s.scores[currentTerm][comp]) filledCount++;
                });
                const hasData = filledCount > 0;
                grid.innerHTML += `<div class="comp-btn ${hasData?'has-data':''}" onclick="launchMobileEntry('scores', '${comp}')">${labels[comp]}</div>`;
            });
        }

        function renderDateSelectionModal() {
            const list = document.getElementById('date-list-group');
            list.innerHTML = '';
            existingDates.forEach(d => {
                list.innerHTML += `<button class="list-group-item list-group-item-action fw-bold text-primary" onclick="launchMobileEntry('attendance', '${d}')">${d}</button>`;
            });
            document.getElementById('new-att-date').value = '';
        }

        window.launchMobileEntry = function(type, key) {
            if (!key) return;
            bootstrap.Modal.getInstance(document.getElementById('scoreSelectModal'))?.hide();
            bootstrap.Modal.getInstance(document.getElementById('dateSelectModal'))?.hide();

            activeEntryType = type;
            activeEntryKey = key;
            entryChanges = {}; 

            const section = document.getElementById('section-select').value;
            const term = document.getElementById('term-select').value;
            let compLabel = type === 'scores' ? key.toUpperCase() : `Att Log: ${key}`;
            
            document.getElementById('mobile-subtitle').innerText = `${section} - ${term.toUpperCase()}`;
            document.getElementById('mobile-title').innerText = compLabel;

            const listContainer = document.getElementById('mobile-entry-list');
            listContainer.innerHTML = '';

            currentStudents.forEach(s => {
                if (s.status === 'Dropped') return;
                
                let html = `<div class="entry-card" data-id="${s.docID}">
                    <div><div class="entry-name">${s.name}</div><div class="entry-uid">${s.uid}</div></div>`;
                
                if (type === 'scores') {
                    // Standard Score Input
                    let val = (s.scores && s.scores[term] && s.scores[term][key]) ? s.scores[term][key] : '';
                    html += `<input type="number" class="mobile-score-input" value="${val}" placeholder="0-100" onchange="trackChange('${s.docID}', this.value)" onkeydown="handleMobileEnter(event, this)">`;
                } else {
                    const logs = (s.attendance_logs && s.attendance_logs[term]) ? s.attendance_logs[term] : {};
                    const val = logs[key] || '';
                    html += `<div class="att-btn-group">
                        <div class="att-btn ${val==='Present'?'active':''}" data-val="Present" onclick="toggleAtt(this, '${s.docID}')">P</div>
                        <div class="att-btn ${val==='Late'?'active':''}" data-val="Late" onclick="toggleAtt(this, '${s.docID}')">L</div>
                        <div class="att-btn ${val==='Excused'?'active':''}" data-val="Excused" onclick="toggleAtt(this, '${s.docID}')">E</div>
                        <div class="att-btn ${val==='Absent'?'active':''}" data-val="Absent" onclick="toggleAtt(this, '${s.docID}')">A</div>
                    </div>`;
                }
                html += `</div>`;
                listContainer.innerHTML += html;
            });

            document.getElementById('teacher-section').classList.add('hidden');
            document.getElementById('mobile-entry-page').classList.remove('hidden');
        }

        window.handleMobileEnter = function(e, el) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const inputs = Array.from(document.querySelectorAll('.mobile-score-input'));
                const idx = inputs.indexOf(el);
                if (idx < inputs.length - 1) {
                    inputs[idx + 1].focus();
                } else {
                    el.blur(); 
                    saveMobileBatch();
                }
            }
        }

        window.closeMobileEntry = function() {
            document.getElementById('mobile-entry-page').classList.add('hidden');
            document.getElementById('teacher-section').classList.remove('hidden');
            loadClassList(); 
        }

        window.trackChange = function(docID, val) {
            entryChanges[docID] = val;
            document.getElementById('mobile-status').innerText = "Unsaved changes...";
        }

        window.toggleAtt = function(el, docID) {
            const siblings = el.parentElement.children;
            let newVal = el.getAttribute('data-val');
            
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                newVal = ""; 
            } else {
                for (let btn of siblings) btn.classList.remove('active');
                el.classList.add('active');
            }
            trackChange(docID, newVal);
        }

        window.saveMobileBatch = async function() {
            const batch = window.writeBatch(window.db);
            const term = currentTerm;
            
            if (Object.keys(entryChanges).length === 0) { showToast("No changes to save"); return; }
            document.getElementById('mobile-status').innerText = "Saving...";

            for (const [id, val] of Object.entries(entryChanges)) {
                const s = currentStudents.find(stu => stu.docID === id);
                if (!s) continue;

                if (activeEntryType === 'scores') {
                    // Standard Score Update
                    if (!s.scores) s.scores = {};
                    if (!s.scores[term]) s.scores[term] = {};
                    s.scores[term][activeEntryKey] = val;
                    
                    // Recalculate Period Grade
                    const att = getAttendanceScore(s, term); // Use smart getter
                    const final = calculatePeriodGrade(s.scores[term], att);
                    
                    // Update Local & Batch
                    if (!s.grades) s.grades = {};
                    s.grades[term] = final;
                    
                    const updateObj = {};
                    updateObj[`scores.${term}.${activeEntryKey}`] = val;
                    updateObj[`grades.${term}`] = final;
                    batch.update(window.doc(window.db, "students", id), updateObj);

                } else if (activeEntryType === 'attendance') {
                    // Update Log
                    if (!s.attendance_logs) s.attendance_logs = {};
                    if (!s.attendance_logs[term]) s.attendance_logs[term] = {};
                    s.attendance_logs[term][activeEntryKey] = val;
                    
                    // Recalculate Attendance Score locally
                    const logs = s.attendance_logs[term];
                    const dates = Object.keys(logs).filter(d => logs[d]); 
                    let score = 0;
                    dates.forEach(d => { if (logs[d] !== 'Absent') score++; });
                    const percent = dates.length > 0 ? Math.round((score / dates.length) * 100) : 0; 
                    
                    // Recalculate Period Grade with new Attendance
                    if (!s.scores) s.scores = {};
                    if (!s.scores[term]) s.scores[term] = {};
                    const final = calculatePeriodGrade(s.scores[term], percent);

                    // Update Local & Batch
                    if (!s.attendance) s.attendance = {};
                    s.attendance[term] = percent;
                    if (!s.grades) s.grades = {};
                    s.grades[term] = final;

                    const updateObj = {};
                    updateObj[`attendance_logs.${term}.${activeEntryKey}`] = val;
                    updateObj[`attendance.${term}`] = percent;
                    updateObj[`grades.${term}`] = final;
                    batch.update(window.doc(window.db, "students", id), updateObj);
                }
            }

            try {
                await batch.commit();
                showToast("Saved Successfully");
                document.getElementById('mobile-status').innerText = "All changes saved.";
                entryChanges = {}; 
            } catch (e) {
                showToast("Error saving: " + e.message, "error");
            }
        }

        // --- CSV Import ---
        window.processCSV = async function() {
            const f = document.getElementById('csv-file'); if(!f.files.length) return showToast("Select File", "error");
            const r = new FileReader();
            const pBar = document.getElementById('import-progress-bar');
            const pContainer = document.getElementById('import-progress-container');
            const pText = document.getElementById('progress-percent');
            pContainer.classList.remove('hidden'); pBar.style.width = '0%'; pText.innerText = '0%';

            r.onload = async function(e) {
                const lines = e.target.result.split(/\r?\n/);
                let c=0;
                for(let i=1; i<lines.length; i++) {
                    const txt = lines[i]; if(!txt.trim()) continue;
                    const row = txt.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                    if(!row||row.length<5) continue;
                    const cl = (v)=>v?v.replace(/^"|"$/g,'').trim():'';
                    const uid=cl(row[0]), sec=cl(row[4]);
                    try {
                        await window.setDoc(window.doc(window.db,"students",uid+"_"+sec), {
                            uid:uid, password:cl(row[1]), name:cl(row[2]), subject:cl(row[3]), section:sec, course:cl(row[5]), status:cl(row[6])||'Active'
                        }, {merge:true});
                        c++;
                        const percent = Math.round((i / lines.length) * 100);
                        pBar.style.width = percent + '%'; pText.innerText = percent + '%';
                    } catch(err){console.error(err);}
                }
                showToast(`Uploaded ${c} records`);
                document.getElementById('import-modal').classList.add('hidden');
                pContainer.classList.add('hidden');
                await fetchSectionsForDropdown();
            };
            r.readAsText(f.files[0]);
        }

        // --- STUDENT PORTAL LOGIC ---
        function initStudentPortal() {
            if (allStudentSubjects.length === 0) return;
            const select = document.getElementById('student-subject-select');
            select.innerHTML = '';
            allStudentSubjects.forEach((sub, index) => {
                const opt = document.createElement('option');
                opt.value = index; opt.text = `${sub.subject} (${sub.section})`; select.appendChild(opt);
            });
            renderStudentPage(allStudentSubjects[0]);
        }
        window.switchStudentSubject = function() {
            const index = document.getElementById('student-subject-select').value;
            renderStudentPage(allStudentSubjects[index]);
        }
        function renderStudentPage(data) {
            activeStudentSubject = data;
            document.getElementById('student-name-display').innerText = `${data.name} | ${data.course}`;
            document.getElementById('lbl-prelim-w').innerText = `${globalWeights.prelim}%`;
            document.getElementById('lbl-mid-w').innerText = `${globalWeights.midterm}%`;
            document.getElementById('lbl-fin-w').innerText = `${globalWeights.finals}%`;
            
            const g = data.grades || {};
            
            const prelimAtt = getAttendanceScore(data, 'prelim');
            const p = calculatePeriodGrade(data.scores?.prelim || {}, prelimAtt);
            
            const midAtt = getAttendanceScore(data, 'midterm');
            const m = calculatePeriodGrade(data.scores?.midterm || {}, midAtt);
            
            const finAtt = getAttendanceScore(data, 'finals');
            const f = calculatePeriodGrade(data.scores?.finals || {}, finAtt);
            
            // Format and Set Colors for Terms
            const setGrade = (id, val) => {
                const el = document.getElementById(id);
                if (val !== null && !isNaN(val)) {
                    el.innerText = val.toFixed(2);
                    el.style.color = getGradeStyling(val).color;
                } else {
                    el.innerText = "--";
                    el.style.color = "var(--primary-blue)";
                }
            };

            setGrade('s-prelim', p);
            setGrade('s-midterm', m);
            setGrade('s-finals', f);
            
            // Final Card Styling
            const finalCard = calculateCardGrade(p, m, f);
            const cardEl = document.getElementById('s-card');
            const cardContainer = document.getElementById('card-grade-container');
            const cardLabel = document.getElementById('card-grade-label');
            
            if (finalCard !== null) {
                cardEl.innerText = finalCard; // Integer
                const style = getGradeStyling(finalCard);
                cardEl.style.color = style.color;
                cardLabel.style.color = style.color;
                cardContainer.style.borderTopColor = style.color;
                cardContainer.style.backgroundColor = style.bg;
            } else {
                cardEl.innerText = "--";
                // Reset to default style
                cardEl.style.color = "var(--success-green)";
                cardContainer.style.borderTopColor = "var(--success-green)";
                cardContainer.style.backgroundColor = "#f0fff4";
            }
            
            showStudentTerm('prelim', document.querySelector('.nav-link.active'));
            document.getElementById('target-grade-input').value = "";
            document.getElementById('f-prelim-box').classList.add('hidden');
            document.getElementById('f-midterm-box').classList.add('hidden');
            document.getElementById('f-finals-box').classList.add('hidden');
            updateProgressBars(null);
        }
        window.showStudentTerm = function(term, btn) {
            if (!activeStudentSubject) return;
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            const data = activeStudentSubject;
            const scores = (data.scores && data.scores[term]) ? data.scores[term] : {};
            
            const att = getAttendanceScore(data, term);
            
            let sum=0, c=0; 
            ['q1','q2','q3','q4','q5'].forEach(k => {
                if(scores[k] !== "" && scores[k] !== undefined && scores[k] !== null) {
                    sum+=parseFloat(scores[k]); c++;
                }
            });
            const qAvg = c>0 ? (sum/c).toFixed(1) : '-';
            
            const qComp = (c>0 ? (sum/c) : 0) * (globalWeights.quiz/100);
            const pComp = (parseFloat(scores.proj)||0) * (globalWeights.project/100);
            const eComp = (parseFloat(scores.exam)||0) * (globalWeights.exam/100);
            const aComp = (parseFloat(att)||0) * (globalWeights.attendance/100);

            const termGrade = calculatePeriodGrade(scores, att);

            document.getElementById('student-term-detail').innerHTML = `
                <div class="row g-4"><div class="col-md-6"><div class="card p-3 h-100 bg-white border-0 shadow-sm">
                <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">Scores</h6>
                <table class="table table-sm table-borderless small"><tbody>
                <tr><td class="text-muted">Quiz 1</td><td class="fw-bold text-end">${scores.q1 || '-'}</td></tr>
                <tr><td class="text-muted">Quiz 2</td><td class="fw-bold text-end">${scores.q2 || '-'}</td></tr>
                <tr><td class="text-muted">Quiz 3</td><td class="fw-bold text-end">${scores.q3 || '-'}</td></tr>
                <tr><td class="text-muted">Quiz 4</td><td class="fw-bold text-end">${scores.q4 || '-'}</td></tr>
                <tr><td class="text-muted">Quiz 5</td><td class="fw-bold text-end">${scores.q5 || '-'}</td></tr>
                <tr class="border-top"><td class="text-dark"><strong>Quiz Avg</strong></td><td class="text-primary text-end"><strong>${qAvg}</strong></td></tr>
                </tbody></table></div></div>
                <div class="col-md-6"><div class="card p-3 h-100 bg-white border-0 shadow-sm">
                <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">Computation</h6>
                <table class="table table-sm table-borderless small"><tbody>
                <tr><td class="text-muted">Quizzes (${globalWeights.quiz}%)</td><td class="fw-bold text-end">${qComp.toFixed(1)}</td></tr>
                <tr><td class="text-muted">Project (${globalWeights.project}%)</td><td class="fw-bold text-end">${pComp.toFixed(1)}</td></tr>
                <tr><td class="text-muted">Exam (${globalWeights.exam}%)</td><td class="fw-bold text-end">${eComp.toFixed(1)}</td></tr>
                <tr><td class="text-muted">Attendance (${globalWeights.attendance}%)</td><td class="fw-bold text-end d-flex align-items-center justify-content-end gap-2">${aComp.toFixed(1)} <button class="btn btn-outline-primary icon-btn" style="width:24px; height:24px; font-size:12px;" onclick="window.currentLogs=activeStudentSubject.attendance_logs?.['${term}']; showAttModal()"><i class="bi bi-list-task"></i></button></td></tr>
                <tr class="table-primary rounded"><td class="p-2 text-primary"><strong>${term.toUpperCase()}</strong></td><td class="p-2 text-primary text-end"><strong>${termGrade.toFixed(2)}</strong></td></tr>
                </tbody></table></div></div></div>`;
        }
        window.showAttModal = function() {
            const body = document.getElementById('att-modal-body'); const logs = window.currentLogs || {};
            if (Object.keys(logs).length === 0) { body.innerHTML = "<div class='p-3 text-center text-muted small'>No records found.</div>"; } 
            else {
                let html = "<table class='table table-hover mb-0 small'><thead class='table-light'><tr><th class='ps-4'>Date</th><th>Status</th></tr></thead><tbody>";
                Object.keys(logs).sort().forEach(d => {
                    const st = logs[d]; const color = st==='Present'?'text-success':st==='Absent'?'text-danger':st==='Late'?'text-warning':'text-primary';
                    html += `<tr><td class='ps-4'>${d}</td><td class="${color} fw-bold">${st}</td></tr>`;
                });
                html += "</tbody></table>"; body.innerHTML = html;
            }
            new bootstrap.Modal(document.getElementById('attModal')).show();
        }
        window.calculateForecast = function() {
            const target = parseFloat(document.getElementById('target-grade-input').value);
            const getVal = (id) => { const txt = document.getElementById(id).innerText; return (txt === "--" || isNaN(parseFloat(txt))) ? null : parseFloat(txt); };
            const p = getVal('s-prelim'); const m = getVal('s-midterm');
            const prelimBox = document.getElementById('f-prelim-box'); const midBox = document.getElementById('f-midterm-box'); const finBox = document.getElementById('f-finals-box');
            prelimBox.classList.add('hidden'); midBox.classList.add('hidden'); finBox.classList.add('hidden');
            updateProgressBars(target);
            if (!target) return;
            const wP = globalWeights.prelim/100, wM = globalWeights.midterm/100, wF = globalWeights.finals/100;
            const format = (v) => (v>100 ? "Impossible" : (v<0?0:v));
            
            if (p === null && m === null) {
                const rounded = Math.ceil(target);
                prelimBox.classList.remove('hidden'); midBox.classList.remove('hidden'); finBox.classList.remove('hidden');
                document.getElementById('f-prelim').innerText = format(rounded);
                document.getElementById('f-midterm').innerText = format(rounded);
                document.getElementById('f-finals').innerText = format(rounded);
            } else if (p !== null && m === null) {
                const rounded = Math.ceil((target - (p * wP)) / (wM + wF));
                midBox.classList.remove('hidden'); finBox.classList.remove('hidden');
                document.getElementById('f-midterm').innerText = format(rounded);
                document.getElementById('f-finals').innerText = format(rounded);
            } else if (p !== null && m !== null) {
                const rounded = Math.ceil((target - ((p * wP) + (m * wM))) / wF);
                finBox.classList.remove('hidden');
                document.getElementById('f-finals').innerText = format(rounded);
            }
        }
        function updateProgressBars(target) {
            ['prelim', 'midterm', 'finals', 'card'].forEach(term => {
                const box = document.getElementById(`p-${term}-bar-box`);
                const bar = document.getElementById(`p-${term}-bar`);
                
                if (!box || !bar) return;

                const valTxt = document.getElementById(`s-${term}`).innerText;
                if (!target || valTxt === "--") { box.classList.add('hidden'); return; }
                box.classList.remove('hidden');
                const current = parseFloat(valTxt) || 0;
                let percent = (current / target) * 100; if (percent > 100) percent = 100;
                bar.style.width = percent + "%";
                if (current >= target) bar.style.backgroundColor = "var(--success-green)";
                else if (current >= target - 5) bar.style.backgroundColor = "var(--warning-orange)";
                else bar.style.backgroundColor = "var(--danger-red)";
            });
        }
    </script>
</body>
</html>
